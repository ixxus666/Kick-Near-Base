-- SERVICES
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- STORAGE
local STORAGE_NAME = "PersistentSafeZoneData"
local storage = player:FindFirstChild(STORAGE_NAME) or Instance.new("Folder", player)
storage.Name = STORAGE_NAME

local AutoLoad = storage:FindFirstChild("AutoLoad") or Instance.new("BoolValue", storage)
AutoLoad.Name = "AutoLoad"
AutoLoad.Value = true

-- STATE
local activeWaypoints = {}
local waypointObjects = {}
local walls = {}
local kickEnabled = false
local espEnabled = false
local themeColor = Color3.fromRGB(255, 60, 60)

-- GUI
local gui = Instance.new("ScreenGui", PlayerGui)
gui.Name = "SafetyHub"
gui.ResetOnSpawn = false

local main = Instance.new("Frame", gui)
main.Size = UDim2.fromOffset(240, 420)
main.Position = UDim2.fromScale(0.5, 0.5)
main.AnchorPoint = Vector2.new(0.5, 0.5)
main.BackgroundColor3 = Color3.fromRGB(20,20,20)
main.BorderSizePixel = 0
Instance.new("UICorner", main).CornerRadius = UDim.new(0,12)

local title = Instance.new("TextLabel", main)
title.Size = UDim2.new(1, -60, 0, 40)
title.Position = UDim2.fromOffset(15, 0)
title.Text = "SAFETY HUB"
title.TextXAlignment = Enum.TextXAlignment.Left
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.FredokaOne
title.TextSize = 14

local settingsBtn = Instance.new("TextButton", main)
settingsBtn.Size = UDim2.fromOffset(30,30)
settingsBtn.Position = UDim2.new(1,-40,0,6)
settingsBtn.Text = "âš™"
settingsBtn.BackgroundTransparency = 1
settingsBtn.TextColor3 = Color3.new(1,1,1)
settingsBtn.TextSize = 18

local function makeButton(text, parent, color)
	local b = Instance.new("TextButton", parent)
	b.Size = UDim2.new(1,-10,0,32)
	b.Text = text
	b.BackgroundColor3 = color or Color3.fromRGB(35,35,35)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.FredokaOne
	b.TextSize = 12
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,6)
	return b
end

-- PANELS
local panel = Instance.new("Frame", main)
panel.Size = UDim2.new(1,-20,1,-60)
panel.Position = UDim2.fromOffset(10,50)
panel.BackgroundTransparency = 1

local layout = Instance.new("UIListLayout", panel)
layout.Padding = UDim.new(0,8)

-- WAYPOINT LOGIC
local function clearZone()
	for _,v in pairs(walls) do v:Destroy() end
	for _,v in pairs(waypointObjects) do v:Destroy() end
	walls = {}
	waypointObjects = {}
	activeWaypoints = {}
end

local function drawWall(a,b)
	local p = Instance.new("Part", workspace)
	p.Anchored = true
	p.CanCollide = false
	p.Material = Enum.Material.ForceField
	p.Color = themeColor
	p.Transparency = 0.5
	p.Size = Vector3.new(0.2, 12, (a-b).Magnitude)
	p.CFrame = CFrame.new(a:Lerp(b,0.5), b)
	table.insert(walls,p)
end

local function renderZone()
	for _,v in pairs(walls) do v:Destroy() end
	walls = {}
	if #activeWaypoints == 4 then
		drawWall(activeWaypoints[1], activeWaypoints[2])
		drawWall(activeWaypoints[2], activeWaypoints[3])
		drawWall(activeWaypoints[3], activeWaypoints[4])
		drawWall(activeWaypoints[4], activeWaypoints[1])
	end
end

local function setPoint(i)
	local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	activeWaypoints[i] = hrp.Position

	if waypointObjects[i] then waypointObjects[i]:Destroy() end
	local p = Instance.new("Part", workspace)
	p.Anchored = true
	p.CanCollide = false
	p.Material = Enum.Material.Neon
	p.Size = Vector3.one
	p.Position = hrp.Position
	p.Color = themeColor
	waypointObjects[i] = p

	renderZone()
end

-- BUTTONS
for i=1,4 do
	makeButton("SET POINT "..i, panel).MouseButton1Click:Connect(function()
		setPoint(i)
	end)
end

makeButton("RESET POINTS", panel, Color3.fromRGB(80,40,40)).MouseButton1Click:Connect(clearZone)

local kickBtn = makeButton("ACTIVE KICK: OFF", panel)
kickBtn.MouseButton1Click:Connect(function()
	kickEnabled = not kickEnabled
	kickBtn.Text = kickEnabled and "SYSTEM ARMED" or "ACTIVE KICK: OFF"
	kickBtn.BackgroundColor3 = kickEnabled and Color3.fromRGB(150,0,0) or Color3.fromRGB(35,35,35)
end)

local espBtn = makeButton("VISUALS: OFF", panel)
espBtn.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	espBtn.Text = espEnabled and "VISUALS: ON" or "VISUALS: OFF"
end)

-- ESP
RunService.RenderStepped:Connect(function()
	for _,plr in pairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local box = plr.Character:FindFirstChild("SafetyESP") or Instance.new("BoxHandleAdornment", plr.Character)
			box.Name = "SafetyESP"
			box.Adornee = plr.Character.HumanoidRootPart
			box.Size = Vector3.new(4,6,4)
			box.Color3 = themeColor
			box.AlwaysOnTop = true
			box.Transparency = 0.5
			box.Visible = espEnabled
		end
	end
end)

-- KICK CHECK
RunService.Heartbeat:Connect(function()
	if kickEnabled and #activeWaypoints == 4 then
		local center = (activeWaypoints[1]+activeWaypoints[2]+activeWaypoints[3]+activeWaypoints[4]) / 4
		for _,plr in pairs(Players:GetPlayers()) do
			if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
				if (plr.Character.HumanoidRootPart.Position - center).Magnitude < 15 then
					player:Kick("Safety Hub: Perimeter Breached")
				end
			end
		end
	end
end)

-- MOBILE DRAG
local dragging, dragStart, startPos
main.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = i.Position
		startPos = main.Position
	end
end)

UserInputService.InputChanged:Connect(function(i)
	if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
		local delta = i.Position - dragStart
		main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

UserInputService.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
		dragging = false
	end
end)
